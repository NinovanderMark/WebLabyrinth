(()=>{"use strict";var t={318:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Color=void 0;e.Color=function(t,e,r){this.hue=t,this.saturation=e,this.lightness=r}},934:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Game=void 0;var o=r(865),i=r(993),n=r(961),s=r(51),a=r(937),h=r(941),l=function(){function t(t,e){this.textureLimit=16,this.currentTileX=0,this.currentTileY=0,this.currentTime=0,this.previousTime=0,this.renderer=t,this.input=e,this.player=new i.Player(17,19)}return t.prototype.loadRoom=function(t){var e=this,r=new URL(t);console.log("Loading new room from URL",r.href),fetch(r.href).then((function(i){if(!i.ok)throw new Error("Unable to retrieve room at URL: ".concat(t));i.json().then((function(t){var i=t;o.Room.validate(i),e.world=n.World.from(i,r),e.tick()}))}))},t.prototype.tick=function(){0===this.previousTime?this.previousTime=performance.now():this.previousTime=this.currentTime,this.currentTime=performance.now();var t=(this.currentTime-this.previousTime)/1e3;this.gameStep(t),this.world.step(t),this.renderer.render(this),window.requestAnimationFrame(this.tick.bind(this))},t.prototype.gameStep=function(t){if(this.input.keyQueue.length>0&&(null!=this.input.keyQueue.find((function(t){return"m"===t}))&&this.renderer.toggleMap(),this.input.clearQueue()),this.input.usePressed||this.input.leftMouseUp){var e=a.RayCast.ray(this.player.position,this.player.direction,this.player.plane,0,this.world);e.hit&&e.perpWallDist<2&&e.worldObject instanceof h.Door&&e.worldObject.interact()}if(this.input.anyDirectional()||null!=this.input.mouseDragStart){var r=this.getMovementFromInput();if(0!==r.x||0!==r.y){var o=this.player.position.add(r);if(!(o.y>this.world.objects.length||o.y<0||o.x>this.world.objects[0].length||o.x<0)){this.currentTileX=Math.floor(o.x),this.currentTileY=Math.floor(o.y);var i=this.world.objects[this.currentTileY][this.currentTileX];null!=i&&i.collidable()||(this.player.position=o)}}}},t.prototype.getMovementFromInput=function(){this.input.leftPressed?this.player.rotateBy(1.5):this.input.rightPressed&&this.player.rotateBy(-1.5);var t=0,e=0;if(this.input.upPressed?(e+=this.player.direction.y*this.player.movementSpeed,t+=this.player.direction.x*this.player.movementSpeed):this.input.downPressed&&(e-=this.player.direction.y*this.player.movementSpeed,t-=this.player.direction.x*this.player.movementSpeed),null!=this.input.mouseDragStart){this.player.rotateBy(.01*(this.input.mouseDragStart.x-this.input.mousePosition.x));var r=5e-4*(this.input.mouseDragStart.y-this.input.mousePosition.y);r>.01?(e=this.player.direction.y*Math.min(r,this.player.movementSpeed),t=this.player.direction.x*Math.min(r,this.player.movementSpeed)):r<-.01&&(e=this.player.direction.y*Math.max(r,-this.player.movementSpeed),t=this.player.direction.x*Math.max(r,-this.player.movementSpeed))}return new s.Vector(t,e)},t}();e.Game=l},322:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Input=void 0;var o=r(51),i=function(){function t(){this.upPressed=!1,this.downPressed=!1,this.leftPressed=!1,this.rightPressed=!1,this.usePressed=!1,this.leftMousePressed=!1,this.previousLeftMousePressed=!1,this.mouseDragStart=null,this.mousePosition=new o.Vector(0,0),this.keyQueue=[]}return Object.defineProperty(t.prototype,"leftMouseUp",{get:function(){return!!this.previousLeftMousePressed&&(this.previousLeftMousePressed=!1,!0)},enumerable:!1,configurable:!0}),t.prototype.attachEventListeners=function(t){var e=this;t.addEventListener("keydown",(function(t){"ArrowLeft"===t.key&&(e.leftPressed=!0),"ArrowRight"===t.key&&(e.rightPressed=!0),"ArrowUp"===t.key&&(e.upPressed=!0),"ArrowDown"===t.key&&(e.downPressed=!0)," "===t.key&&(e.usePressed=!0)})),t.addEventListener("keyup",(function(t){"ArrowLeft"===t.key&&(e.leftPressed=!1),"ArrowRight"===t.key&&(e.rightPressed=!1),"ArrowUp"===t.key&&(e.upPressed=!1),"ArrowDown"===t.key&&(e.downPressed=!1)," "===t.key&&(e.usePressed=!1),1===t.key.length&&e.keyQueue.push(t.key)})),t.addEventListener("mousedown",(function(r){if(0===r.button){var i=t.getBoundingClientRect();e.leftMousePressed=!0,e.mouseDragStart=new o.Vector(r.clientX-i.left,r.clientY-i.top)}})),t.addEventListener("mousemove",(function(r){var i=t.getBoundingClientRect();e.mousePosition=new o.Vector(r.clientX-i.left,r.clientY-i.top)})),t.addEventListener("mouseup",(function(t){0===t.button&&(e.leftMousePressed=!1,e.previousLeftMousePressed=!0,e.mouseDragStart=null)})),t.addEventListener("touchstart",(function(r){e.leftMousePressed=!0;var i=t.getBoundingClientRect(),n=r.changedTouches.item(0).clientX-i.left,s=r.changedTouches.item(0).clientY-i.top;e.mouseDragStart=new o.Vector(n,s)})),t.addEventListener("touchmove",(function(r){var i=t.getBoundingClientRect(),n=r.changedTouches.item(0).clientX-i.left,s=r.changedTouches.item(0).clientY-i.top;e.mousePosition=new o.Vector(n,s)})),t.addEventListener("touchend",(function(t){e.leftMousePressed=!1,e.previousLeftMousePressed=!0,e.mouseDragStart=null}))},t.prototype.anyDirectional=function(){return!!(this.upPressed||this.downPressed||this.leftPressed||this.rightPressed)},t.prototype.clearQueue=function(){this.keyQueue=[]},t}();e.Input=i},993:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Player=void 0;var o=r(51),i=function(){function t(t,e){this.movementSpeed=.05,this.position=new o.Vector(t,e),this.direction=new o.Vector(0,-1),this.plane=new o.Vector(.66,0)}return t.prototype.rotateBy=function(t){this.direction.rotateBy(t),this.plane.rotateBy(t)},t}();e.Player=i},937:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.RayCast=e.RayCastResult=void 0;var o=r(51),i=r(360),n=r(516),s=r(941),a=function(){};e.RayCastResult=a;var h=function(){function t(){}return t.ray=function(t,e,r,h,l,c){void 0===c&&(c=!1);var u,d,p,f,y=e.x+r.x*h,v=e.y+r.y*h,m=Math.floor(t.x),w=Math.floor(t.y),x=Math.abs(1/y),g=Math.abs(1/v);y<0?(u=-1,p=(t.x-m)*x):(u=1,p=(m+1-t.x)*x),v<0?(d=-1,f=(t.y-w)*g):(d=1,f=(w+1-t.y)*g);for(var b,C,P,j,M,R=0,_=0,S=0,k=!1,O=[];0===R;)if(p<f?(p+=x,m+=u,C=0):(f+=g,w+=d,C=1),null!=(j=l.objects[w][m]))if(j instanceof n.Sprite){var T=new i.ViewSprite(m+.5,w+.5,j.texture);O.findIndex((function(t){return t.x===T.x&&t.y===T.y}))<0&&O.push(T),c&&(R=1)}else j instanceof s.Door?(P=j.texture,R=1,1==C?(S=.5*d,M=(w-t.y+S+(1-d)/2)/v,f-g/2<p?(b=t.x+M*y,(b-=Math.floor(b))<=j.openAmount&&(R=0,S=0)):(m+=u,C=0,k=!0,S=0,P=l.objects[w][m].texture)):(_=.5*u,M=(m-t.x+_+(1-u)/2)/y,p-x/2<f?(b=t.y+M*v,(b-=Math.floor(b))<j.openAmount&&(R=0,_=0)):(w+=d,C=1,k=!0,_=0,P=l.objects[w][m].texture))):(P=j.texture,R=1);M=0===C?(m-t.x+_+(1-u)/2)/y:(w-t.y+S+(1-d)/2)/v;var W=new a;return W.sprites=O,W.hit=1===R,W.side=C,W.perpWallDist=M,W.inside=k,W.worldObject=j,W.texture=P,W.direction=new o.Vector(y,v),W},t}();e.RayCast=h},882:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Renderer=void 0;var o=r(318),i=r(516),n=r(941),s=r(937),a=function(){function t(t,e,r,o,i){this.texWidth=64,this.texHeight=64,this.screenWidth=t,this.screenHeight=e,this.resourceResolver=r,this.canvas=o,this.canvas.width=this.screenWidth,this.canvas.height=this.screenHeight;var n=this.canvas.getContext("2d");if(null==n)throw new Error("Unable to get 2D rendering context from Canvas");this.drawContext=n,this.drawContext.imageSmoothingEnabled=!1,null!=i&&(this.depthContext=i.getContext("2d"))}return t.prototype.toggleMap=function(){this.mapVisible=!this.mapVisible},t.prototype.render=function(t){this.drawContext.fillStyle="#000",this.drawContext.fillRect(0,0,this.screenWidth,this.screenHeight);var e=this.resourceResolver.getTextures(t.world),r=this.resourceResolver.getSprites(t.world);if(0===e.naturalWidth||0===e.naturalHeight||0===r.naturalWidth||0===r.naturalHeight)return this.drawContext.fillStyle="#fff",this.drawContext.font="30px Arial",this.drawContext.textAlign="center",void this.drawContext.fillText("Loading textures...",this.screenWidth/2,this.screenHeight/2);this.renderCeilingFloor(t),this.renderWalls(t,e,r),this.mapVisible&&this.renderMap(t)},t.prototype.renderCeilingFloor=function(t){var e=this.getBlockColor(t.world.ceiling);this.drawContext.fillStyle="hsl("+e.hue+","+e.saturation+"%,"+e.lightness/2+"%)",this.drawContext.fillRect(0,0,this.screenWidth,this.screenHeight/2);var r=this.getBlockColor(t.world.floor);this.drawContext.fillStyle="hsl("+r.hue+","+r.saturation+"%,"+r.lightness/4+"%)",this.drawContext.fillRect(0,this.screenHeight/2,this.screenWidth,this.screenHeight/2)},t.prototype.renderWalls=function(t,e,r){var o=this,i=[];i.fill(0,0,this.screenWidth);for(var a=[],h=0;h<this.screenWidth;h++){var l=2*h/this.screenWidth-1,c=s.RayCast.ray(t.player.position,t.player.direction,t.player.plane,l,t.world);c.sprites.forEach((function(t){a.findIndex((function(e){return e.x===t.x&&e.y===t.y&&e.sprite===t.sprite}))<0&&a.push(t)}));var u,d=Math.floor(this.screenHeight/c.perpWallDist),p=-d/2+this.screenHeight/2+0,f=d/2+this.screenHeight/2+0;u=0==c.side?t.player.position.y+c.perpWallDist*c.direction.y:t.player.position.x+c.perpWallDist*c.direction.x;var y=(u-=Math.floor(u))*this.texWidth;0==c.side&&c.direction.x>0&&(y=this.texWidth-y),1==c.side&&c.direction.y<0&&(y=this.texWidth-y),c.worldObject instanceof n.Door&&!c.inside&&(0==c.side&&c.direction.x>0||1==c.side&&c.direction.y<0?y+=Math.floor(c.worldObject.openAmount*this.texWidth):y-=Math.floor(c.worldObject.openAmount*this.texWidth));var v=Math.floor(this.texWidth+c.texture*this.texWidth-y);this.drawContext.drawImage(e,v,0,1,this.texHeight,h,p,1,f-p),1===c.side&&(this.drawContext.strokeStyle="rgba(0,0,0,0.6)",this.drawContext.beginPath(),this.drawContext.moveTo(h,p),this.drawContext.lineTo(h,f),this.drawContext.stroke()),i[h]=c.perpWallDist}if(a.sort((function(e,r){return r.distanceTo(t.player.position.x,t.player.position.y)-e.distanceTo(t.player.position.x,t.player.position.y)})),a.forEach((function(e){return o.renderSpriteBillboard(e,t,i,0,r)})),null!=this.depthContext)for(var m=t.world.objects.length,w=0;w<this.screenWidth;w++){var x=i[w]/m*100;this.depthContext.strokeStyle="hsl(0, 0%, ".concat(100-x,"%)"),this.depthContext.beginPath(),this.depthContext.moveTo(w,0),this.depthContext.lineTo(w,this.screenHeight),this.depthContext.stroke()}},t.prototype.renderSpriteBillboard=function(t,e,r,o,i){var n=t.x-e.player.position.x,s=t.y-e.player.position.y,a=1/(e.player.plane.x*e.player.direction.y-e.player.direction.x*e.player.plane.y),h=a*(e.player.direction.y*n-e.player.direction.x*s),l=a*(-e.player.plane.y*n+e.player.plane.x*s),c=Math.floor(this.screenWidth/2*(1+h/l)),u=Math.abs(Math.floor(this.screenHeight/l)),d=Math.abs(Math.floor(this.screenHeight/l)),p=Math.floor(-d/2+c);p<0&&(p=0);var f=d/2+c;f>=this.screenWidth&&(f=this.screenWidth-1);for(var y=p;y<f;y++){var v=Math.floor((y-(-d/2+c))*this.texWidth/d);if(l>0&&y>0&&y<this.screenWidth&&l<r[y]){var m=t.sprite*this.texWidth+v,w=-u/2+this.screenHeight/2+o;this.drawContext.drawImage(i,m,0,1,this.texHeight,y,w,1,u),r[y]=l}}},t.prototype.renderMap=function(t){for(var e=0;e<t.world.objects.length;e++)for(var r=0;r<t.world.objects[e].length;r++){var o=t.world.objects[e][r];if(null!=o){var s=this.getBlockColor(o.texture+1);this.drawContext.fillStyle="hsl("+s.hue+","+s.saturation+"%,"+s.lightness+"%)",o instanceof i.Sprite?(this.drawContext.strokeStyle="#f77",this.drawCircle(8*(r+.5),8*(e+.5),4)):o instanceof n.Door&&!o.block?null==(r>0?t.world.objects[e][r-1]:t.world.objects[e][r+1])?this.drawContext.fillRect(8*(r+.25),8*e,4,8):this.drawContext.fillRect(8*r,8*(e+.25),8,4):this.drawContext.fillRect(8*r,8*e,8,8),t.currentTileX===r&&t.currentTileY===e&&(this.drawContext.strokeStyle="#f0f",this.drawContext.strokeRect(8*r,8*e,8,8))}}var a=8*t.player.position.x,h=8*t.player.position.y;this.drawContext.strokeStyle="#fff",this.drawCircle(a,h,4),this.drawContext.beginPath(),this.drawContext.moveTo(a,h),this.drawContext.lineTo(a+8*t.player.direction.x,h+8*t.player.direction.y),this.drawContext.stroke()},t.prototype.drawCircle=function(t,e,r){this.drawContext.beginPath(),this.drawContext.arc(t,e,r,0,2*Math.PI),this.drawContext.stroke()},t.prototype.getBlockColor=function(t){var e=0,r=100,i=50;return 0===t?(r=0,i=0):e=40*t,new o.Color(e,r,i)},t}();e.Renderer=a},360:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ViewSprite=void 0;var r=function(){function t(t,e,r){this.x=t,this.y=e,this.sprite=r}return t.prototype.distanceTo=function(t,e){return(t-this.x)*(t-this.x)+(e-this.y)*(e-this.y)},t}();e.ViewSprite=r},171:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ResourceResolver=void 0;var r=function(){function t(t){this.parentElement=t,this.images=new Map}return t.prototype.getTextures=function(t){var e=this.images.get(t.textures.href);return null!=e?e:this.addResource(t.textures.href)},t.prototype.getSprites=function(t){var e=this.images.get(t.sprites.href);return null!=e?e:this.addResource(t.sprites.href)},t.prototype.addResource=function(t){var e=document.createElement("img");return e.src=t,e.classList.add("hidden"),this.parentElement.appendChild(e),this.images.set(t,e),e},t}();e.ResourceResolver=r},865:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Room=void 0;var r=function(){function t(){}return t.validate=function(t){if(null==t.textures||t.textures.length<1)throw new Error("Room does not reference a texture file");if(null==t.sprites||t.sprites.length<1)throw new Error("Room does not reference a sprites file");if(null==t.objects||t.objects.length<1)throw new Error("Room contains no objects");if(null==t.tiles||t.tiles.length<1)throw new Error("Room contains no tiles");for(var e=t.tiles[0].length,r=0;r<t.tiles.length;r++){if(t.tiles[r].length!=e)throw new Error("Irregular row length for row ".concat(r,", expected: ").concat(e," actual: ").concat(t.tiles[r].length));for(var o=0;o<t.tiles[r].length;o++)if(t.tiles[r][o]<0||t.tiles[r][o]>t.objects.length)throw new Error("Tile reference out of bounds at coordinates ".concat(o,",").concat(r,". Should be between 0 and ").concat(t.objects.length))}},t}();e.Room=r},51:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Vector=void 0;var r=function(){function t(t,e){this.x=t,this.y=e}return t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.rotateBy=function(t){t=-t*(Math.PI/180);var e=Math.cos(t),r=Math.sin(t),o=Math.round(1e4*(this.x*e-this.y*r))/1e4,i=Math.round(1e4*(this.x*r+this.y*e))/1e4;this.x=o,this.y=i},t}();e.Vector=r},941:function(t,e,r){var o,i=this&&this.__extends||(o=function(t,e){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},o(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0}),e.Door=void 0;var n=function(t){function e(e,r){void 0===r&&(r=!1);var o=t.call(this,e)||this;return o.closed=!0,o.openAmount=0,o.openTime=0,o.block=r,o}return i(e,t),e.prototype.collidable=function(){return 1!==this.openAmount},e.prototype.interact=function(){this.closed&&0===this.openAmount?(this.closed=!1,this.openTime=0):this.closed||1!==this.openAmount||(this.closed=!0)},e.prototype.step=function(t){this.closed&&this.openAmount>0&&(console.log("Closing",this.openAmount),this.openAmount-=t),!this.closed&&this.openAmount<1&&(console.log("Opening",this.openAmount),this.openAmount+=t),this.openAmount>1&&(this.openAmount=1),this.openAmount<0&&(this.openAmount=0),1===this.openAmount&&(this.openTime+=t),this.openTime>5&&(this.closed=!0)},e}(r(511).GameObject);e.Door=n},511:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.GameObject=void 0;var r=function(){function t(t){this.texture=t}return t.prototype.collidable=function(){return!0},t}();e.GameObject=r},516:function(t,e,r){var o,i=this&&this.__extends||(o=function(t,e){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},o(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0}),e.Sprite=void 0;var n=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e.prototype.distanceBetween=function(t,e,r,o){return(r-t)*(r-t)+(o-e)*(o-e)},e}(r(511).GameObject);e.Sprite=n},961:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.World=void 0;var o=r(511),i=r(941),n=r(516),s=function(){function t(){this.ceiling=5,this.floor=2,this.objects=[],this.dynamicObjects=[]}return t.prototype.step=function(t){this.dynamicObjects.forEach((function(e){return e.step(t)}))},t.prototype.cacheDynamicObjects=function(){this.dynamicObjects.splice(0);for(var t=0;t<this.objects.length;t++)for(var e=0;e<this.objects[t].length;e++){var r=this.objects[t][e];r instanceof i.Door&&this.dynamicObjects.push(r)}},t.from=function(e,r){var s=r.pathname.split("/");s.splice(s.length-1,1);var a=s.join("/"),h=new t;h.textures=new URL("".concat(a,"/").concat(e.textures),r.origin),h.sprites=new URL("".concat(a,"/").concat(e.sprites),r.origin);for(var l=0;l<e.tiles.length;l++){for(var c=[],u=0;u<e.tiles[l].length;u++){var d=e.tiles[l][u]-1;if(d<0)c.push(null);else{var p=e.objects[d];switch(p.type){case"block":c.push(new o.GameObject(p.texture));break;case"door":c.push(new i.Door(p.texture,!1));break;case"sprite":c.push(new n.Sprite(p.texture));break;default:throw new Error("Unknown type '".concat(p.type,"' for object ").concat(d," at ").concat(u,",").concat(l))}}}h.objects.push(c)}return h.cacheDynamicObjects(),h},t}();e.World=s}},e={};function r(o){var i=e[o];if(void 0!==i)return i.exports;var n=e[o]={exports:{}};return t[o].call(n.exports,n,n.exports,r),n.exports}(()=>{var t=r(934),e=r(171),o=r(322),i=r(882),n=new o.Input;n.attachEventListeners(document.getElementsByTagName("body")[0]);var s=document.getElementById("canvas"),a=document.getElementById("depth"),h=document.getElementById("client-parent"),l=new e.ResourceResolver(h),c=new i.Renderer(1024,768,l,s,a),u=new t.Game(c,n),d=new URL("./assets/room.json",document.baseURI).href,p=new URLSearchParams(window.location.search);null!=p.get("url")&&(d=p.get("url")),u.loadRoom(d)})()})();
//# sourceMappingURL=main.7d0a26dbe7d1f5c347cf.js.map