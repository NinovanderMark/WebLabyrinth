(()=>{"use strict";var t={318:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Color=void 0;e.Color=function(t,e,i){this.hue=t,this.saturation=e,this.lightness=i}},934:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Game=void 0;var r=i(993),o=i(961),n=i(51),s=i(937),h=i(941),a=function(){function t(t,e){this.textureLimit=16,this.currentTileX=0,this.currentTileY=0,this.currentTime=0,this.previousTime=0,this.renderer=t,this.input=e,this.player=new r.Player(17,19)}return t.prototype.load=function(t){this.world=o.World.from(t,this.textureLimit)},t.prototype.tick=function(){0===this.previousTime?this.previousTime=performance.now():this.previousTime=this.currentTime,this.currentTime=performance.now();var t=(this.currentTime-this.previousTime)/1e3;this.gameStep(t),this.world.step(t),this.renderer.render(this),window.requestAnimationFrame(this.tick.bind(this))},t.prototype.gameStep=function(t){if(this.input.keyQueue.length>0&&(null!=this.input.keyQueue.find((function(t){return"m"===t}))&&this.renderer.toggleMap(),this.input.clearQueue()),this.input.usePressed||this.input.leftMouseUp){var e=s.RayCast.ray(this.player.position,this.player.direction,this.player.plane,0,this.world);e.hit&&e.perpWallDist<2&&e.worldObject instanceof h.Door&&e.worldObject.interact()}if(this.input.anyDirectional()||null!=this.input.mouseDragStart){var i=this.getMovementFromInput();if(0!==i.x||0!==i.y){var r=this.player.position.add(i);if(!(r.y>this.world.objects.length||r.y<0||r.x>this.world.objects[0].length||r.x<0)){this.currentTileX=Math.floor(r.x),this.currentTileY=Math.floor(r.y);var o=this.world.objects[this.currentTileY][this.currentTileX];null!=o&&o.collidable()||(this.player.position=r)}}}},t.prototype.getMovementFromInput=function(){this.input.leftPressed?this.player.rotateBy(1.5):this.input.rightPressed&&this.player.rotateBy(-1.5);var t=0,e=0;if(this.input.upPressed?(e+=this.player.direction.y*this.player.movementSpeed,t+=this.player.direction.x*this.player.movementSpeed):this.input.downPressed&&(e-=this.player.direction.y*this.player.movementSpeed,t-=this.player.direction.x*this.player.movementSpeed),null!=this.input.mouseDragStart){this.player.rotateBy(.01*(this.input.mouseDragStart.x-this.input.mousePosition.x));var i=5e-4*(this.input.mouseDragStart.y-this.input.mousePosition.y);i>.01?(e=this.player.direction.y*Math.min(i,this.player.movementSpeed),t=this.player.direction.x*Math.min(i,this.player.movementSpeed)):i<-.01&&(e=this.player.direction.y*Math.max(i,-this.player.movementSpeed),t=this.player.direction.x*Math.max(i,-this.player.movementSpeed))}return new n.Vector(t,e)},t}();e.Game=a},322:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Input=void 0;var r=i(51),o=function(){function t(){this.upPressed=!1,this.downPressed=!1,this.leftPressed=!1,this.rightPressed=!1,this.usePressed=!1,this.leftMousePressed=!1,this.previousLeftMousePressed=!1,this.mouseDragStart=null,this.mousePosition=new r.Vector(0,0),this.keyQueue=[]}return Object.defineProperty(t.prototype,"leftMouseUp",{get:function(){return!!this.previousLeftMousePressed&&(this.previousLeftMousePressed=!1,!0)},enumerable:!1,configurable:!0}),t.prototype.attachEventListeners=function(t){var e=this;t.addEventListener("keydown",(function(t){"ArrowLeft"===t.key&&(e.leftPressed=!0),"ArrowRight"===t.key&&(e.rightPressed=!0),"ArrowUp"===t.key&&(e.upPressed=!0),"ArrowDown"===t.key&&(e.downPressed=!0)," "===t.key&&(e.usePressed=!0)})),t.addEventListener("keyup",(function(t){"ArrowLeft"===t.key&&(e.leftPressed=!1),"ArrowRight"===t.key&&(e.rightPressed=!1),"ArrowUp"===t.key&&(e.upPressed=!1),"ArrowDown"===t.key&&(e.downPressed=!1)," "===t.key&&(e.usePressed=!1),1===t.key.length&&e.keyQueue.push(t.key)})),t.addEventListener("mousedown",(function(i){if(0===i.button){var o=t.getBoundingClientRect();e.leftMousePressed=!0,e.mouseDragStart=new r.Vector(i.clientX-o.left,i.clientY-o.top)}})),t.addEventListener("mousemove",(function(i){var o=t.getBoundingClientRect();e.mousePosition=new r.Vector(i.clientX-o.left,i.clientY-o.top)})),t.addEventListener("mouseup",(function(t){0===t.button&&(e.leftMousePressed=!1,e.previousLeftMousePressed=!0,e.mouseDragStart=null)})),t.addEventListener("touchstart",(function(i){e.leftMousePressed=!0;var o=t.getBoundingClientRect(),n=i.changedTouches.item(0).clientX-o.left,s=i.changedTouches.item(0).clientY-o.top;e.mouseDragStart=new r.Vector(n,s)})),t.addEventListener("touchmove",(function(i){var o=t.getBoundingClientRect(),n=i.changedTouches.item(0).clientX-o.left,s=i.changedTouches.item(0).clientY-o.top;e.mousePosition=new r.Vector(n,s)})),t.addEventListener("touchend",(function(t){e.leftMousePressed=!1,e.previousLeftMousePressed=!0,e.mouseDragStart=null}))},t.prototype.anyDirectional=function(){return!!(this.upPressed||this.downPressed||this.leftPressed||this.rightPressed)},t.prototype.clearQueue=function(){this.keyQueue=[]},t}();e.Input=o},993:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Player=void 0;var r=i(51),o=function(){function t(t,e){this.movementSpeed=.05,this.position=new r.Vector(t,e),this.direction=new r.Vector(0,-1),this.plane=new r.Vector(.66,0)}return t.prototype.rotateBy=function(t){this.direction.rotateBy(t),this.plane.rotateBy(t)},t}();e.Player=o},937:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.RayCast=e.RayCastResult=void 0;var r=i(51),o=i(360),n=i(516),s=i(941),h=function(){};e.RayCastResult=h;var a=function(){function t(){}return t.ray=function(t,e,i,a,l,c){void 0===c&&(c=!1);var u,p,d,f,y=e.x+i.x*a,v=e.y+i.y*a,m=Math.floor(t.x),x=Math.floor(t.y),w=Math.abs(1/y),g=Math.abs(1/v);y<0?(u=-1,d=(t.x-m)*w):(u=1,d=(m+1-t.x)*w),v<0?(p=-1,f=(t.y-x)*g):(p=1,f=(x+1-t.y)*g);for(var b,C,P,M,j,_=0,S=0,O=0,k=!1,T=[];0===_;)if(d<f?(d+=w,m+=u,C=0):(f+=g,x+=p,C=1),null!=(M=l.objects[x][m]))if(M instanceof n.Sprite){var W=new o.ViewSprite(m+.5,x+.5,M.texture);T.findIndex((function(t){return t.x===W.x&&t.y===W.y}))<0&&T.push(W),c&&(_=1)}else M instanceof s.Door?(P=M.texture,_=1,1==C?(O=.5*p,j=(x-t.y+O+(1-p)/2)/v,f-g/2<d?(b=t.x+j*y,(b-=Math.floor(b))<=M.openAmount&&(_=0,O=0)):(m+=u,C=0,k=!0,O=0,P=l.objects[x][m].texture)):(S=.5*u,j=(m-t.x+S+(1-u)/2)/y,d-w/2<f?(b=t.y+j*v,(b-=Math.floor(b))<M.openAmount&&(_=0,S=0)):(x+=p,C=1,k=!0,S=0,P=l.objects[x][m].texture))):(P=M.texture,_=1);j=0===C?(m-t.x+S+(1-u)/2)/y:(x-t.y+O+(1-p)/2)/v;var D=new h;return D.sprites=T,D.hit=1===_,D.side=C,D.perpWallDist=j,D.inside=k,D.worldObject=M,D.texture=P,D.direction=new r.Vector(y,v),D},t}();e.RayCast=a},882:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Renderer=void 0;var r=i(318),o=i(516),n=i(941),s=i(937),h=function(){function t(t,e,i,r,o,n){this.texWidth=64,this.texHeight=64,this.screenWidth=t,this.screenHeight=e,this.textures=r,this.sprites=o,this.canvas=i,this.canvas.width=this.screenWidth,this.canvas.height=this.screenHeight;var s=this.canvas.getContext("2d");if(null==s)throw new Error("Unable to get 2D rendering context from Canvas");this.drawContext=s,this.drawContext.imageSmoothingEnabled=!1,null!=n&&(this.depthContext=n.getContext("2d"))}return t.prototype.toggleMap=function(){this.mapVisible=!this.mapVisible},t.prototype.render=function(t){this.drawContext.fillStyle="#000",this.drawContext.fillRect(0,0,this.screenWidth,this.screenHeight),this.renderCeilingFloor(t),this.renderWalls(t),this.mapVisible&&this.renderMap(t)},t.prototype.renderCeilingFloor=function(t){var e=this.getBlockColor(t.world.ceiling);this.drawContext.fillStyle="hsl("+e.hue+","+e.saturation+"%,"+e.lightness/2+"%)",this.drawContext.fillRect(0,0,this.screenWidth,this.screenHeight/2);var i=this.getBlockColor(t.world.floor);this.drawContext.fillStyle="hsl("+i.hue+","+i.saturation+"%,"+i.lightness/4+"%)",this.drawContext.fillRect(0,this.screenHeight/2,this.screenWidth,this.screenHeight/2)},t.prototype.renderWalls=function(t){var e=this,i=[];i.fill(0,0,this.screenWidth);for(var r=[],o=0;o<this.screenWidth;o++){var h=2*o/this.screenWidth-1,a=s.RayCast.ray(t.player.position,t.player.direction,t.player.plane,h,t.world);a.sprites.forEach((function(t){r.findIndex((function(e){return e.x===t.x&&e.y===t.y&&e.sprite===t.sprite}))<0&&r.push(t)}));var l,c=Math.floor(this.screenHeight/a.perpWallDist),u=-c/2+this.screenHeight/2+0,p=c/2+this.screenHeight/2+0;l=0==a.side?t.player.position.y+a.perpWallDist*a.direction.y:t.player.position.x+a.perpWallDist*a.direction.x;var d=(l-=Math.floor(l))*this.texWidth;0==a.side&&a.direction.x>0&&(d=this.texWidth-d),1==a.side&&a.direction.y<0&&(d=this.texWidth-d),a.worldObject instanceof n.Door&&!a.inside&&(0==a.side&&a.direction.x>0||1==a.side&&a.direction.y<0?d+=Math.floor(a.worldObject.openAmount*this.texWidth):d-=Math.floor(a.worldObject.openAmount*this.texWidth));var f=Math.floor(this.texWidth+a.texture*this.texWidth-d);this.drawContext.drawImage(this.textures,f,0,1,this.texHeight,o,u,1,p-u),1===a.side&&(this.drawContext.strokeStyle="rgba(0,0,0,0.6)",this.drawContext.beginPath(),this.drawContext.moveTo(o,u),this.drawContext.lineTo(o,p),this.drawContext.stroke()),i[o]=a.perpWallDist}if(r.sort((function(e,i){return i.distanceTo(t.player.position.x,t.player.position.y)-e.distanceTo(t.player.position.x,t.player.position.y)})),r.forEach((function(r){return e.renderSpriteBillboard(r,t,i,0)})),null!=this.depthContext)for(var y=t.world.objects.length,v=0;v<this.screenWidth;v++){var m=i[v]/y*100;this.depthContext.strokeStyle="hsl(0, 0%, ".concat(100-m,"%)"),this.depthContext.beginPath(),this.depthContext.moveTo(v,0),this.depthContext.lineTo(v,this.screenHeight),this.depthContext.stroke()}},t.prototype.renderSpriteBillboard=function(t,e,i,r){var o=t.x-e.player.position.x,n=t.y-e.player.position.y,s=1/(e.player.plane.x*e.player.direction.y-e.player.direction.x*e.player.plane.y),h=s*(e.player.direction.y*o-e.player.direction.x*n),a=s*(-e.player.plane.y*o+e.player.plane.x*n),l=Math.floor(this.screenWidth/2*(1+h/a)),c=Math.abs(Math.floor(this.screenHeight/a)),u=Math.abs(Math.floor(this.screenHeight/a)),p=Math.floor(-u/2+l);p<0&&(p=0);var d=u/2+l;d>=this.screenWidth&&(d=this.screenWidth-1);for(var f=p;f<d;f++){var y=Math.floor((f-(-u/2+l))*this.texWidth/u);if(a>0&&f>0&&f<this.screenWidth&&a<i[f]){var v=t.sprite*this.texWidth+y,m=-c/2+this.screenHeight/2+r;this.drawContext.drawImage(this.sprites,v,0,1,this.texHeight,f,m,1,c),i[f]=a}}},t.prototype.renderMap=function(t){for(var e=0;e<t.world.objects.length;e++)for(var i=0;i<t.world.objects[e].length;i++){var r=t.world.objects[e][i];if(null!=r){var s=this.getBlockColor(r.texture+1);this.drawContext.fillStyle="hsl("+s.hue+","+s.saturation+"%,"+s.lightness+"%)",r instanceof o.Sprite?(this.drawContext.strokeStyle="#f77",this.drawCircle(8*(i+.5),8*(e+.5),4)):r instanceof n.Door&&!r.block?null==(i>0?t.world.objects[e][i-1]:t.world.objects[e][i+1])?this.drawContext.fillRect(8*(i+.25),8*e,4,8):this.drawContext.fillRect(8*i,8*(e+.25),8,4):this.drawContext.fillRect(8*i,8*e,8,8),t.currentTileX===i&&t.currentTileY===e&&(this.drawContext.strokeStyle="#f0f",this.drawContext.strokeRect(8*i,8*e,8,8))}}var h=8*t.player.position.x,a=8*t.player.position.y;this.drawContext.strokeStyle="#fff",this.drawCircle(h,a,4),this.drawContext.beginPath(),this.drawContext.moveTo(h,a),this.drawContext.lineTo(h+8*t.player.direction.x,a+8*t.player.direction.y),this.drawContext.stroke()},t.prototype.drawCircle=function(t,e,i){this.drawContext.beginPath(),this.drawContext.arc(t,e,i,0,2*Math.PI),this.drawContext.stroke()},t.prototype.getBlockColor=function(t){var e=0,i=100,o=50;return 0===t?(i=0,o=0):e=40*t,new r.Color(e,i,o)},t}();e.Renderer=h},360:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ViewSprite=void 0;var i=function(){function t(t,e,i){this.x=t,this.y=e,this.sprite=i}return t.prototype.distanceTo=function(t,e){return(t-this.x)*(t-this.x)+(e-this.y)*(e-this.y)},t}();e.ViewSprite=i},51:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Vector=void 0;var i=function(){function t(t,e){this.x=t,this.y=e}return t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.rotateBy=function(t){t=-t*(Math.PI/180);var e=Math.cos(t),i=Math.sin(t),r=Math.round(1e4*(this.x*e-this.y*i))/1e4,o=Math.round(1e4*(this.x*i+this.y*e))/1e4;this.x=r,this.y=o},t}();e.Vector=i},941:function(t,e,i){var r,o=this&&this.__extends||(r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},r(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0}),e.Door=void 0;var n=function(t){function e(e,i){void 0===i&&(i=!1);var r=t.call(this,e)||this;return r.closed=!0,r.openAmount=0,r.openTime=0,r.block=i,r}return o(e,t),e.prototype.collidable=function(){return 1!==this.openAmount},e.prototype.interact=function(){this.closed&&0===this.openAmount?(this.closed=!1,this.openTime=0):this.closed||1!==this.openAmount||(this.closed=!0)},e.prototype.step=function(t){this.closed&&this.openAmount>0&&(console.log("Closing",this.openAmount),this.openAmount-=t),!this.closed&&this.openAmount<1&&(console.log("Opening",this.openAmount),this.openAmount+=t),this.openAmount>1&&(this.openAmount=1),this.openAmount<0&&(this.openAmount=0),1===this.openAmount&&(this.openTime+=t),this.openTime>5&&(this.closed=!0)},e}(i(511).GameObject);e.Door=n},511:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.GameObject=void 0;var i=function(){function t(t){this.texture=t}return t.prototype.collidable=function(){return!0},t}();e.GameObject=i},516:function(t,e,i){var r,o=this&&this.__extends||(r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},r(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(e,"__esModule",{value:!0}),e.Sprite=void 0;var n=function(t){function e(e){return t.call(this,e)||this}return o(e,t),e.prototype.distanceBetween=function(t,e,i,r){return(i-t)*(i-t)+(r-e)*(r-e)},e}(i(511).GameObject);e.Sprite=n},961:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.World=void 0;var r=i(511),o=i(941),n=i(516),s=function(){function t(){this.ceiling=5,this.floor=2,this.objects=[],this.dynamicObjects=[]}return t.prototype.step=function(t){this.dynamicObjects.forEach((function(e){return e.step(t)}))},t.prototype.cacheDynamicObjects=function(){this.dynamicObjects.splice(0);for(var t=0;t<this.objects.length;t++)for(var e=0;e<this.objects[t].length;e++){var i=this.objects[t][e];i instanceof o.Door&&this.dynamicObjects.push(i)}},t.from=function(e,i){for(var s=new t,h=0;h<e.length;h++){for(var a=[],l=0;l<e[h].length;l++){var c=e[h][l]-1;if(c<0)a.push(null);else if(c<i)a.push(new r.GameObject(c));else if(c<2*i)a.push(new n.Sprite(c-i));else if(c<3*i)a.push(new o.Door(c-2*i));else{if(!(c<4*i))throw new Error("Invalid tile number of ".concat(c+i," at ").concat(h,",").concat(l));a.push(new o.Door(c-3*i,!0))}}s.objects.push(a)}return s.cacheDynamicObjects(),s},t}();e.World=s}},e={};function i(r){var o=e[r];if(void 0!==o)return o.exports;var n=e[r]={exports:{}};return t[r].call(n.exports,n,n.exports,i),n.exports}(()=>{var t=i(934),e=i(322),r=i(882),o=new e.Input;o.attachEventListeners(document.getElementsByTagName("body")[0]);var n=document.getElementById("canvas"),s=document.getElementById("depth"),h=document.getElementById("textures"),a=document.getElementById("sprites"),l=new r.Renderer(1024,768,n,h,a,s),c=new t.Game(l,o);fetch("assets/world.json").then((function(t){t.json().then((function(t){c.load(t),c.tick()}))}))})()})();
//# sourceMappingURL=main.aef838c5e93a8a695667.js.map