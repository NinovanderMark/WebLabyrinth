(()=>{"use strict";var e={19:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Color=void 0;t.Color=function(e,t,r){this.hue=e,this.saturation=t,this.lightness=r}},745:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Vector=void 0;var r=function(){function e(e,t){this.x=e,this.y=t}return e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y)},e.prototype.rotateBy=function(e){e=-e*(Math.PI/180);var t=Math.cos(e),r=Math.sin(e),i=Math.round(1e4*(this.x*t-this.y*r))/1e4,n=Math.round(1e4*(this.x*r+this.y*t))/1e4;this.x=i,this.y=n},e}();t.Vector=r},775:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GameEventHandler=void 0;var r=function(){function e(e,t){this.game=e,this.guiManager=t}return e.prototype.handle=function(e){e.handle(this)},e}();t.GameEventHandler=r},158:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GameEvent=void 0;t.GameEvent=function(){}},296:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.ItemConsumedEvent=void 0;var o=function(e){function t(t){var r=e.call(this)||this;return r.item=t,r}return n(t,e),t.prototype.handle=function(e){var t=e.game.world.items.get(this.item).texture;e.guiManager.addDialog("Item consumed",t,e.game.world)},t}(r(158).GameEvent);t.ItemConsumedEvent=o},931:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.ItemRequiredEvent=void 0;var o=function(e){function t(t){var r=e.call(this)||this;return r.item=t,r}return n(t,e),t.prototype.handle=function(e){var t=e.game.world.items.get(this.item).texture;e.guiManager.addDialog("Missing required item",t,e.game.world)},t}(r(158).GameEvent);t.ItemRequiredEvent=o},841:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Game=void 0;var i=r(960),n=r(538),o=r(272),s=r(745),a=r(644),l=r(866),c=r(626),h=r(775),u=function(){function e(e,t,r){this.currentTileX=0,this.currentTileY=0,this.currentTime=0,this.previousTime=0,this.renderer=e,this.input=t,this.guiManager=r,this.handler=new h.GameEventHandler(this,r),this.player=new n.Player(17,19),this.events=new Array}return e.prototype.loadRoom=function(e){var t=this,r=new URL(e);console.log("Loading new room from URL",r.href),fetch(r.href,{method:"get",mode:"cors"}).then((function(n){if(!n.ok)throw new Error("Unable to retrieve room at URL: ".concat(e));n.json().then((function(e){var n=e;i.Room.validate(n),t.world=o.World.from(n,r),t.tick()}))}))},e.prototype.tick=function(){var e=this;0===this.previousTime?this.previousTime=performance.now():this.previousTime=this.currentTime,this.currentTime=performance.now();var t=(this.currentTime-this.previousTime)/1e3;this.gameStep(t),this.world.step(t),this.renderer.render(this,t),this.guiManager.tick(this,t),this.events.forEach((function(t){return e.handler.handle(t)})),this.events=[],window.requestAnimationFrame(this.tick.bind(this))},e.prototype.addEvent=function(e){this.events.push(e)},e.prototype.gameStep=function(e){if(this.input.keyQueue.length>0&&(null!=this.input.keyQueue.find((function(e){return"m"===e}))&&this.renderer.toggleMap(),this.input.clearQueue()),this.input.usePressed||this.input.leftMouseUp){var t=a.RayCast.ray(this.player.position,this.player.direction,this.player.plane,0,this.world);t.hit&&t.perpWallDist<2&&t.worldObject instanceof l.Door&&t.worldObject.interact(this)}if(this.input.anyDirectional()||null!=this.input.mouseDragStart){var r=this.getMovementFromInput();if(0!==r.x||0!==r.y){var i=this.player.position.add(r);if(!(i.y>this.world.objects.length||i.y<0||i.x>this.world.objects[0].length||i.x<0)){this.currentTileX=Math.floor(i.x),this.currentTileY=Math.floor(i.y);var n=this.world.objects[this.currentTileY][this.currentTileX];null!=n&&n.collidable()||(this.player.position=i,n instanceof c.Pickup&&(n.onPickup(this.player),this.world.objects[this.currentTileY][this.currentTileX]=null))}}}},e.prototype.getMovementFromInput=function(){this.input.leftPressed?this.player.rotateBy(1.5):this.input.rightPressed&&this.player.rotateBy(-1.5);var e=0,t=0;if(this.input.upPressed?(t+=this.player.direction.y*this.player.movementSpeed,e+=this.player.direction.x*this.player.movementSpeed):this.input.downPressed&&(t-=this.player.direction.y*this.player.movementSpeed,e-=this.player.direction.x*this.player.movementSpeed),null!=this.input.mouseDragStart){this.player.rotateBy(.01*(this.input.mouseDragStart.x-this.input.mousePosition.x));var r=5e-4*(this.input.mouseDragStart.y-this.input.mousePosition.y);r>.01?(t=this.player.direction.y*Math.min(r,this.player.movementSpeed),e=this.player.direction.x*Math.min(r,this.player.movementSpeed)):r<-.01&&(t=this.player.direction.y*Math.max(r,-this.player.movementSpeed),e=this.player.direction.x*Math.max(r,-this.player.movementSpeed))}return new s.Vector(e,t)},e}();t.Game=u},304:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Item=void 0;t.Item=function(e,t,r){void 0===r&&(r=1),this.amount=r,this.sprite=t,this.name=e}},538:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Player=void 0;var i=r(745),n=function(){function e(e,t){this.movementSpeed=.05,this.items=[],this.position=new i.Vector(e,t),this.direction=new i.Vector(0,-1),this.plane=new i.Vector(.66,0)}return Object.defineProperty(e.prototype,"score",{get:function(){var e=0;return this.items.forEach((function(t){"score"===t.name&&(e+=t.amount)})),e},enumerable:!1,configurable:!0}),e.prototype.rotateBy=function(e){this.direction.rotateBy(e),this.plane.rotateBy(e)},e}();t.Player=n},644:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RayCast=t.RayCastResult=void 0;var i=r(745),n=r(723),o=r(51),s=r(866),a=function(){};t.RayCastResult=a;var l=function(){function e(){}return e.ray=function(e,t,r,l,c,h){void 0===h&&(h=!1);var u,d,p,f,y=t.x+r.x*l,v=t.y+r.y*l,m=Math.floor(e.x),g=Math.floor(e.y),w=Math.abs(1/y),x=Math.abs(1/v);y<0?(u=-1,p=(e.x-m)*w):(u=1,p=(m+1-e.x)*w),v<0?(d=-1,f=(e.y-g)*x):(d=1,f=(g+1-e.y)*x);for(var b,_,P,j,M,C=0,k=0,E=0,O=!1,R=[];0===C;)if(p<f?(p+=w,m+=u,_=0):(f+=x,g+=d,_=1),null!=(j=c.objects[g][m]))if(j instanceof o.Sprite){var S=new n.ViewSprite(m+.5,g+.5,j.texture,j.scale);R.findIndex((function(e){return e.x===S.x&&e.y===S.y}))<0&&R.push(S),h&&(C=1)}else j instanceof s.Door?j.block?j.openAmount<1&&(1===_&&f-x*(1-2*j.openAmount)<p?(C=1,P=j.texture,E=2*j.openAmount*d):0===_&&p-w*(1-2*j.openAmount)<f&&(C=1,P=j.texture,k=2*j.openAmount*u)):(P=j.texture,C=1,1==_?(E=.5*d,M=(g-e.y+E+(1-d)/2)/v,f-x/2<p?(b=e.x+M*y,(b-=Math.floor(b))<=j.openAmount&&(C=0,E=0)):(m+=u,_=0,O=!0,E=0,P=c.objects[g][m].texture)):(k=.5*u,M=(m-e.x+k+(1-u)/2)/y,p-w/2<f?(b=e.y+M*v,(b-=Math.floor(b))<j.openAmount&&(C=0,k=0)):(g+=d,_=1,O=!0,k=0,P=c.objects[g][m].texture))):(P=j.texture,C=1);M=0===_?(m-e.x+k+(1-u)/2)/y:(g-e.y+E+(1-d)/2)/v;var T=new a;return T.sprites=R,T.hit=1===C,T.side=_,T.perpWallDist=M,T.inside=O,T.worldObject=j,T.texture=P,T.direction=new i.Vector(y,v),T},e}();t.RayCast=l},960:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Room=void 0;var r=function(){function e(){}return e.validate=function(e){if(null==e.textures||e.textures.length<1)throw new Error("Room does not reference a texture file");if(null==e.sprites||e.sprites.length<1)throw new Error("Room does not reference a sprites file");if(null==e.objects||e.objects.length<1)throw new Error("Room contains no objects");if(null==e.tiles||e.tiles.length<1)throw new Error("Room contains no tiles");for(var t=e.tiles[0].length,r=0;r<e.tiles.length;r++){if(e.tiles[r].length!=t)throw console.debug("Faulty row looks like",e.tiles[r]),new Error("Irregular row length for row ".concat(r,", expected: ").concat(t," actual: ").concat(e.tiles[r].length));for(var i=0;i<e.tiles[r].length;i++)if(e.tiles[r][i]<0||e.tiles[r][i]>e.objects.length)throw new Error("Tile reference out of bounds at coordinates ".concat(i,",").concat(r,". Should be between 0 and ").concat(e.objects.length))}},e}();t.Room=r},866:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.Door=void 0;var o=r(858),s=r(931),a=r(296),l=function(e){function t(t,r,i,n){void 0===r&&(r=!1),void 0===i&&(i=null),void 0===n&&(n=null);var o=e.call(this,t)||this;return o.closed=!0,o.openAmount=0,o.openTime=0,o.block=r,o.key=i,o.unlockTexture=null!=n?n:t,o}return n(t,e),t.prototype.collidable=function(){return 1!==this.openAmount},t.prototype.unlock=function(){this.key=null,this.texture=this.unlockTexture},t.prototype.interact=function(e){var t=this;if(null!=this.key){var r=this.key,i=e.player.items.findIndex((function(e){return e.name===t.key&&e.amount>0}));return i<0?void e.addEvent(new s.ItemRequiredEvent(r)):(e.player.items[i].amount-=1,this.unlock(),void e.addEvent(new a.ItemConsumedEvent(r)))}this.closed&&0===this.openAmount?(this.closed=!1,this.openTime=0):this.closed||1!==this.openAmount||(this.closed=!0)},t.prototype.step=function(e){var t=this.block?.2*e:e;this.closed&&this.openAmount>0&&(this.openAmount-=t),!this.closed&&this.openAmount<1&&(console.debug("Opening",t),this.openAmount+=t),this.openAmount>1&&(this.openAmount=1),this.openAmount<0&&(this.openAmount=0),this.block||(1===this.openAmount&&(this.openTime+=e),this.openTime>5&&(this.closed=!0))},t}(o.GameObject);t.Door=l},858:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GameObject=void 0;var r=function(){function e(e){this.texture=e}return e.prototype.collidable=function(){return!0},e}();t.GameObject=r},626:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.Pickup=void 0;var o=r(51),s=r(304),a=function(e){function t(t,r,i,n){void 0===i&&(i=1),void 0===n&&(n=1);var o=e.call(this,t,n)||this;return o.amount=i,o.name=r,o}return n(t,e),t.prototype.collidable=function(){return!1},t.prototype.onPickup=function(e){var t=this,r=e.items.findIndex((function(e){return e.name===t.name}));r>=0?e.items[r].amount+=this.amount:e.items.push(new s.Item(this.name,this.texture,this.amount))},t}(o.Sprite);t.Pickup=a},51:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},i(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.Sprite=void 0;var o=function(e){function t(t,r){void 0===r&&(r=1);var i=e.call(this,t)||this;return i.scale=r,i}return n(t,e),t.prototype.distanceBetween=function(e,t,r,i){return(r-e)*(r-e)+(i-t)*(i-t)},t}(r(858).GameObject);t.Sprite=o},272:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.World=void 0;var i=r(858),n=r(866),o=r(51),s=r(626),a=function(){function e(){this.ceiling=5,this.floor=2,this.objects=[],this.dynamicObjects=[],this.items=new Map}return e.prototype.step=function(e){this.dynamicObjects.forEach((function(t){return t.step(e)}))},e.prototype.cacheDynamicObjects=function(){this.dynamicObjects.splice(0);for(var e=0;e<this.objects.length;e++)for(var t=0;t<this.objects[e].length;t++){var r=this.objects[e][t];r instanceof n.Door&&this.dynamicObjects.push(r)}},e.from=function(t,r){var a=r.pathname.split("/");a.splice(a.length-1,1);var l=a.join("/"),c=new e;c.textures=new URL("".concat(l,"/").concat(t.textures),r.origin),c.sprites=new URL("".concat(l,"/").concat(t.sprites),r.origin);for(var h=0;h<t.tiles.length;h++){for(var u=[],d=0;d<t.tiles[h].length;d++){var p=t.tiles[h][d]-1;if(p<0)u.push(null);else{var f=t.objects[p];switch(f.type){case"block":u.push(new i.GameObject(f.texture));break;case"door":var y=f.block,v=f["texture-unlocked"];u.push(new n.Door(f.texture,null!=y&&y,f.key,v));break;case"sprite":u.push(new o.Sprite(f.texture));break;case"item":var m=f.scale,g=f.amount,w=f.name,x=new s.Pickup(f.texture,w,null!=g?g:1,null!=m?m:1);u.push(x),c.items.set(w,x);break;default:throw new Error("Unknown type '".concat(f.type,"' for object ").concat(p," at ").concat(d,",").concat(h))}}}c.objects.push(u)}return c.cacheDynamicObjects(),c},e}();t.World=a},405:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Dialog=void 0;var r=function(){function e(e,t,r){void 0===r&&(r=null),this.message=e,this.sprite=r,this.element=t,this.alive=0}return e.prototype.addDelta=function(e){this.alive+=e},e}();t.Dialog=r},932:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GuiManager=void 0;var i=r(405),n=function(){function e(e,t){this.lastScore=-1,this.texWidth=64,this.texHeight=64,this.resourceResolver=e,this.parentElement=t,this.scoreElement=document.createElement("p"),this.scoreElement.classList.add("score"),this.parentElement.appendChild(this.scoreElement)}return e.prototype.addDialog=function(e,t,r){if(void 0===t&&(t=null),void 0===r&&(r=null),this.dialog){var n=this.dialog.element;this.parentElement.removeChild(n)}var o=document.createElement("div");o.classList.add("dialog");var s=document.createElement("p");s.innerText=e,null!=t&&null!=r&&o.appendChild(this.createSpriteCanvas(t,r)),o.appendChild(s),this.parentElement.appendChild(o),this.dialog=new i.Dialog(e,o,t)},e.prototype.tick=function(e,t){this.dialog&&(this.dialog.addDelta(t),this.dialog.alive>3&&(this.parentElement.removeChild(this.dialog.element),this.dialog=null)),e.player.score!==this.lastScore&&(this.lastScore=e.player.score,this.scoreElement.innerText="".concat(this.lastScore).padStart(10,"0"))},e.prototype.createSpriteCanvas=function(e,t){var r=document.createElement("canvas");r.width=this.texWidth,r.height=this.texHeight;var i=r.getContext("2d");if(null==i)throw new Error("Unable to create 2D context");var n=this.resourceResolver.getSprites(t);return i.drawImage(n,e*this.texWidth,0,this.texWidth,this.texHeight,0,0,this.texWidth,this.texHeight),r},e}();t.GuiManager=n},321:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Input=void 0;var i=r(745),n=function(){function e(){this.upPressed=!1,this.downPressed=!1,this.leftPressed=!1,this.rightPressed=!1,this.usePressed=!1,this.leftMousePressed=!1,this.previousLeftMousePressed=!1,this.mouseDragStart=null,this.mousePosition=new i.Vector(0,0),this.keyQueue=[]}return Object.defineProperty(e.prototype,"leftMouseUp",{get:function(){return!!this.previousLeftMousePressed&&(this.previousLeftMousePressed=!1,!0)},enumerable:!1,configurable:!0}),e.prototype.attachEventListeners=function(e){var t=this;e.addEventListener("keydown",(function(e){"ArrowLeft"===e.key&&(t.leftPressed=!0),"ArrowRight"===e.key&&(t.rightPressed=!0),"ArrowUp"===e.key&&(t.upPressed=!0),"ArrowDown"===e.key&&(t.downPressed=!0)," "===e.key&&(t.usePressed=!0)})),e.addEventListener("keyup",(function(e){"ArrowLeft"===e.key&&(t.leftPressed=!1),"ArrowRight"===e.key&&(t.rightPressed=!1),"ArrowUp"===e.key&&(t.upPressed=!1),"ArrowDown"===e.key&&(t.downPressed=!1)," "===e.key&&(t.usePressed=!1),1===e.key.length&&t.keyQueue.push(e.key)})),e.addEventListener("mousedown",(function(r){if(0===r.button){var n=e.getBoundingClientRect();t.leftMousePressed=!0,t.mouseDragStart=new i.Vector(r.clientX-n.left,r.clientY-n.top)}})),e.addEventListener("mousemove",(function(r){var n=e.getBoundingClientRect();t.mousePosition=new i.Vector(r.clientX-n.left,r.clientY-n.top)})),e.addEventListener("mouseup",(function(e){0===e.button&&(t.leftMousePressed=!1,t.previousLeftMousePressed=!0,t.mouseDragStart=null)})),e.addEventListener("touchstart",(function(r){t.leftMousePressed=!0;var n=e.getBoundingClientRect(),o=r.changedTouches.item(0).clientX-n.left,s=r.changedTouches.item(0).clientY-n.top;t.mouseDragStart=new i.Vector(o,s)})),e.addEventListener("touchmove",(function(r){var n=e.getBoundingClientRect(),o=r.changedTouches.item(0).clientX-n.left,s=r.changedTouches.item(0).clientY-n.top;t.mousePosition=new i.Vector(o,s)})),e.addEventListener("touchend",(function(e){t.leftMousePressed=!1,t.previousLeftMousePressed=!0,t.mouseDragStart=null}))},e.prototype.anyDirectional=function(){return!!(this.upPressed||this.downPressed||this.leftPressed||this.rightPressed)},e.prototype.clearQueue=function(){this.keyQueue=[]},e}();t.Input=n},243:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Renderer=void 0;var i=r(19),n=r(51),o=r(866),s=r(644),a=function(){function e(e,t,r,i,n){this.texWidth=64,this.texHeight=64,this.screenWidth=e,this.screenHeight=t,this.resourceResolver=r,this.canvas=i,this.canvas.width=this.screenWidth,this.canvas.height=this.screenHeight;var o=this.canvas.getContext("2d");if(null==o)throw new Error("Unable to get 2D rendering context from Canvas");this.drawContext=o,this.drawContext.imageSmoothingEnabled=!1,this.parentElement=n}return e.prototype.toggleMap=function(){this.mapVisible=!this.mapVisible},e.prototype.render=function(e,t){this.drawContext.fillStyle="#000",this.drawContext.fillRect(0,0,this.screenWidth,this.screenHeight);var r=this.resourceResolver.getTextures(e.world),i=this.resourceResolver.getSprites(e.world);if(0===r.naturalWidth||0===r.naturalHeight||0===i.naturalWidth||0===i.naturalHeight)return this.drawContext.fillStyle="#fff",this.drawContext.font="30px Arial",this.drawContext.textAlign="center",void this.drawContext.fillText("Loading textures...",this.screenWidth/2,this.screenHeight/2);this.renderCeilingFloor(e),this.renderWalls(e,r,i),this.mapVisible&&this.renderMap(e),this.renderInterface(e.player,i,t)},e.prototype.renderInterface=function(e,t,r){var i=this,n=16;e.items.forEach((function(e){if(!(e.amount<1||"score"===e.name)){for(var r=i.screenHeight-(n+48),o=0;o<e.amount;o++)i.drawContext.drawImage(t,e.sprite*i.texWidth,0,i.texWidth,i.texHeight,16+48*o/2,r,48,48);n+=32}}))},e.prototype.renderCeilingFloor=function(e){var t=this.getBlockColor(e.world.ceiling);this.drawContext.fillStyle="hsl("+t.hue+","+t.saturation+"%,"+t.lightness/2+"%)",this.drawContext.fillRect(0,0,this.screenWidth,this.screenHeight/2);var r=this.getBlockColor(e.world.floor);this.drawContext.fillStyle="hsl("+r.hue+","+r.saturation+"%,"+r.lightness/4+"%)",this.drawContext.fillRect(0,this.screenHeight/2,this.screenWidth,this.screenHeight/2)},e.prototype.renderWalls=function(e,t,r){var i=this,n=[];n.fill(0,0,this.screenWidth);for(var a=[],l=0;l<this.screenWidth;l++){var c=2*l/this.screenWidth-1,h=s.RayCast.ray(e.player.position,e.player.direction,e.player.plane,c,e.world);h.sprites.forEach((function(e){a.findIndex((function(t){return t.x===e.x&&t.y===e.y&&t.sprite===e.sprite}))<0&&a.push(e)}));var u,d=Math.floor(this.screenHeight/h.perpWallDist),p=-d/2+this.screenHeight/2+0,f=d/2+this.screenHeight/2+0;u=0==h.side?e.player.position.y+h.perpWallDist*h.direction.y:e.player.position.x+h.perpWallDist*h.direction.x;var y=(u-=Math.floor(u))*this.texWidth;0==h.side&&h.direction.x>0&&(y=this.texWidth-y),1==h.side&&h.direction.y<0&&(y=this.texWidth-y),h.worldObject instanceof o.Door&&!h.worldObject.block&&!h.inside&&(0==h.side&&h.direction.x>0||1==h.side&&h.direction.y<0?y+=Math.floor(h.worldObject.openAmount*this.texWidth):y-=Math.floor(h.worldObject.openAmount*this.texWidth));var v=Math.floor(this.texWidth+h.texture*this.texWidth-y);this.drawContext.drawImage(t,v,0,1,this.texHeight,l,p,1,f-p),1===h.side&&(this.drawContext.strokeStyle="rgba(0,0,0,0.6)",this.drawContext.beginPath(),this.drawContext.moveTo(l,p),this.drawContext.lineTo(l,f),this.drawContext.stroke()),n[l]=h.perpWallDist}a.sort((function(t,r){return r.distanceTo(e.player.position.x,e.player.position.y)-t.distanceTo(e.player.position.x,e.player.position.y)})),a.forEach((function(t){return i.renderSpriteBillboard(t,e,n,0,r)}))},e.prototype.renderSpriteBillboard=function(e,t,r,i,n){var o=e.x-t.player.position.x,s=e.y-t.player.position.y,a=1/(t.player.plane.x*t.player.direction.y-t.player.direction.x*t.player.plane.y),l=a*(t.player.direction.y*o-t.player.direction.x*s),c=a*(-t.player.plane.y*o+t.player.plane.x*s),h=Math.floor(this.screenWidth/2*(1+l/c)),u=Math.abs(Math.floor(this.screenHeight/c)),d=Math.abs(Math.floor(this.screenHeight/c))*e.scale,p=Math.floor(-d/2+h);p<0&&(p=0);var f=d/2+h;f>=this.screenWidth&&(f=this.screenWidth-1);for(var y=p;y<f;y++){var v=Math.floor((y-(-d/2+h))*this.texWidth/d);if(c>0&&y>0&&y<this.screenWidth&&c<r[y]){var m=Math.min(e.sprite*this.texWidth+v,e.sprite*this.texWidth+this.texWidth);m=Math.max(m,e.sprite*this.texWidth);var g=-u*e.scale/2+(u/2-u*e.scale/2)+this.screenHeight/2+i;this.drawContext.drawImage(n,m,0,1,this.texHeight,y,g,1,u*e.scale),r[y]=c}}},e.prototype.renderMap=function(e){for(var t=0;t<e.world.objects.length;t++)for(var r=0;r<e.world.objects[t].length;r++){var i=e.world.objects[t][r];if(null!=i){var s=this.getBlockColor(i.texture+1);this.drawContext.fillStyle="hsl("+s.hue+","+s.saturation+"%,"+s.lightness+"%)",i instanceof n.Sprite?(this.drawContext.strokeStyle="#f77",this.drawCircle(8*(r+.5),8*(t+.5),4)):i instanceof o.Door&&!i.block?null==(r>0?e.world.objects[t][r-1]:e.world.objects[t][r+1])?this.drawContext.fillRect(8*(r+.25),8*t,4,8):this.drawContext.fillRect(8*r,8*(t+.25),8,4):this.drawContext.fillRect(8*r,8*t,8,8),e.currentTileX===r&&e.currentTileY===t&&(this.drawContext.strokeStyle="#f0f",this.drawContext.strokeRect(8*r,8*t,8,8))}}var a=8*e.player.position.x,l=8*e.player.position.y;this.drawContext.strokeStyle="#fff",this.drawCircle(a,l,4),this.drawContext.beginPath(),this.drawContext.moveTo(a,l),this.drawContext.lineTo(a+8*e.player.direction.x,l+8*e.player.direction.y),this.drawContext.stroke()},e.prototype.drawCircle=function(e,t,r){this.drawContext.beginPath(),this.drawContext.arc(e,t,r,0,2*Math.PI),this.drawContext.stroke()},e.prototype.getBlockColor=function(e){var t=0,r=100,n=50;return 0===e?(r=0,n=0):t=40*e,new i.Color(t,r,n)},e}();t.Renderer=a},723:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ViewSprite=void 0;var r=function(){function e(e,t,r,i){void 0===i&&(i=1),this.x=e,this.y=t,this.sprite=r,this.scale=i}return e.prototype.distanceTo=function(e,t){return(e-this.x)*(e-this.x)+(t-this.y)*(t-this.y)},e}();t.ViewSprite=r},392:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ResourceResolver=void 0;var r=function(){function e(e){this.parentElement=e,this.images=new Map}return e.prototype.getTextures=function(e){var t=this.images.get(e.textures.href);return null!=t?t:this.addResource(e.textures.href)},e.prototype.getSprites=function(e){var t=this.images.get(e.sprites.href);return null!=t?t:this.addResource(e.sprites.href)},e.prototype.addResource=function(e){var t=document.createElement("img");return t.src=e,t.classList.add("hidden"),this.parentElement.appendChild(t),this.images.set(e,t),t},e}();t.ResourceResolver=r}},t={};function r(i){var n=t[i];if(void 0!==n)return n.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,r),o.exports}(()=>{var e=r(841),t=r(392),i=r(321),n=r(243),o=r(932),s=new i.Input;s.attachEventListeners(document.getElementsByTagName("body")[0]);var a=document.getElementById("canvas"),l=document.getElementById("depth"),c=document.getElementById("client-parent");c.style.maxWidth="".concat(1024,"px");var h=new t.ResourceResolver(c),u=new n.Renderer(1024,768,h,a,l),d=new o.GuiManager(h,c),p=new e.Game(u,s,d),f=new URL("./assets/room.json",document.baseURI).href,y=new URLSearchParams(window.location.search);null!=y.get("url")&&(f=y.get("url")),p.loadRoom(f)})()})();
//# sourceMappingURL=main.fb60d181ecc5b8f3f0bc.js.map